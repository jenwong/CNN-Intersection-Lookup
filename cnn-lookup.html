<html ng-app='search'>
<head>


<!-- 
Dropbox Linked
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/hogan.js/3.0.2/hogan.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.12/d3.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.10.4/typeahead.bundle.min.js"></script>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.0-rc.5/angular.min.js"></script>
<script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/less.js/1.7.5/less.min.js"></script>
<link   rel="stylesheet"       href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" >
<link   rel="stylesheet/less"  href="./less/main.less" type="text/css" />
 -->

<!-- 
Local Linked -->
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/hogan.js/3.0.2/hogan.js"></script>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.12/d3.min.js"></script>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.10.4/typeahead.bundle.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-rc.5/angular.min.js"></script> 
<script type="text/javascript" src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

<link   rel="stylesheet"       href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" >
<link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,700,400italic,700italic" rel="stylesheet" type="text/css">

<script>
// require hogan
var resultStringTemplate = Hogan.compile("{{CNN}} {{street1}} {{street2}} {{street3}} {{street4}} {{street5}}");

function rowString(row) {
  return resultStringTemplate.render(row);
}

function prettyRowString(row) {
  return rowString(row);
}

// function promoteOrAddSuggestion(array, suggestion) {

// }

angular.module('search', []).controller('Main', ['$scope', function($scope) {
  d3.csv('./IntersectionLookup.csv', function(d) {
    // Edit data model here.
    return d;
  }, function(dataset) {
    // Setup page w/ data here.
    // constructs the suggestion engine
    $scope.totalRows = dataset.length;
    $scope.cnnSelectionHistory = [];
    $scope.selectSuggestion = function(suggestion) {
      $scope.selectedCNN = suggestion.data;
      var oldIndex = $scope.cnnSelectionHistory.indexOf(suggestion.data);
      if( oldIndex > -1) {
        $scope.cnnSelectionHistory.splice(oldIndex, 1);
        $scope.cnnSelectionHistory.splice(0, 0, suggestion.data);
      } else {
        $scope.cnnSelectionHistory.unshift(suggestion.data);
      }
       //AngularJS ng-repeat doesn't like duplicates
    };

    $scope.selectHistoryItem = function(item) {
      $scope.selectedCNN = item;
    }

    $scope.$apply();
    var trafficHound = new Bloodhound({
      datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
      queryTokenizer: function(str) { 
        var tokens = Bloodhound.tokenizers.whitespace(str);
        tokens = tokens.filter(function(token){
          var tokenIsAnd = /^(and)$|^&$/i.test(token);
          return tokenIsAnd ? (tokens.length == 1) : true; 
        });
        return tokens;
      },
      // Bloodhound.tokenizers.whitespace,
      limit: 101,
      local: $.map(dataset, function(row) { 
        return { 
          data: row,
          value: rowString(row),
          displayValue: prettyRowString(row)
        }; 
      })
    });
     
    // kicks off the loading/processing of `local` and `prefetch`
    trafficHound.initialize();

    $scope.$watch('searchText', function(newValue, oldValue) {
      var query = newValue;
      trafficHound.get(query, function(suggestions) {
        $scope.suggestions = suggestions;
        $scope.matchingSuggestionsCount = (suggestions.length > 100) ? '100+' : suggestions.length;
      });
    }); //end $scope.$watch
  });//end d3.csv
}]);//end .controller


</script>

<style>
  td { text-transform: capitalize; }
  h1, th { color: #6A953F; font-weight: 700; }
  body { font-family: "Source Sans Pro",sans-serif; }
  .table-clickable tr { cursor: pointer; }
</style>

</head>
<body ng-controller="Main">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-3">
        <h1>CNN Lookup </h1>
      </div>
      <div class="col-md-9">
        
      </div>
    </div><!-- End Row 1 -->  

    <div class="row">
      <div class="col-md-3">

        <div class="panel panel-default">
          <div class="panel-heading clear">
            <span >Selected CNN: {{selectedCNN.CNN || 'None' }}</span> 

          </div>
          <table class="table table-condensed">
            <tbody> 
              <tr ng-if="selectedCNN.street1"><td>Street 1</td><td> {{selectedCNN.street1 || '' | lowercase }}</td></tr>
              <tr ng-if="selectedCNN.street2"><td>Street 2</td><td> {{selectedCNN.street2 || '' | lowercase }}</td></tr>
              <tr ng-if="selectedCNN.street3"><td>Street 3</td><td> {{selectedCNN.street3 || '' | lowercase }}</td></tr>
              <tr ng-if="selectedCNN.street4"><td>Street 4</td><td> {{selectedCNN.street4 || '' | lowercase }}</td></tr>
              <tr ng-if="selectedCNN.street5"><td>Street 5</td><td> {{selectedCNN.street5 || '' | lowercase }}</td></tr>
            </tbody>
          </table>
        </div><!-- End Last CNN Panel -->

        <div class="panel panel-default">
          <div class="panel-heading">Search History</div>
          <table class="table table-condensed table-hover table-clickable">
            <thead> <th>CNN</th> <th> Address </th> </thead>
            <tbody> 
              <tr ng-repeat="selection in cnnSelectionHistory" ng-click="selectHistoryItem(selection)"> 
                <td> {{ selection['CNN'] }} </td>
                <td> {{ selection['street1'] | lowercase }} & {{ selection['street2'] | lowercase }} </td>
              </tr>
            </tbody>
          </table>
        </div> <!-- End Search History -->

      </div> <!-- End col-md-4 -->
      <div class="col-md-9">


        <div class="input-group">
          <span class="input-group-addon">Search:</span>
          <input class="form-control" ng-model="searchText" style="width: 600px; display: block;" type="text" placeholder="Search by street or cnn.">
        </div>
        <span> {{totalRows || 'Loading the '}} CNNs to search </span>
        <span ng-if="totalRows"> {{matchingSuggestionsCount || '0'}} matches </span>
        <br/>

        <table class="table table-striped table-hover table-clickable">
          <thead>
            <tr>
              <th> CNN </th>
              <th> Street 1 </th>
              <th> Street 2 </th>
              <th> Street 3 </th>
              <th> Street 4 </th>
              <th> Street 5 </th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="suggestion in suggestions" ng-click="selectSuggestion(suggestion)">
              <td> {{ suggestion['data']['CNN']  }} </td>
              <td> {{ suggestion['data']['street1'] | lowercase }} </td>
              <td> {{ suggestion['data']['street2'] | lowercase }} </td>
              <td> {{ suggestion['data']['street3'] | lowercase }} </td>
              <td> {{ suggestion['data']['street4'] | lowercase }} </td>
              <td> {{ suggestion['data']['street5'] | lowercase }} </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div> <!-- End Row 2 -->

   </div><!-- End Container -->
</body>

</html>
